name: Warn on Direct Push to Main

on:
  push:
    branches:
      - main

jobs:
  warn-direct-push:
    runs-on: ubuntu-latest
    steps:
      - name: Check if direct push
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # Skip if this is a merge commit from a PR
          if [[ "$COMMIT_MSG" == Merge\ pull\ request* ]] || [[ "$COMMIT_MSG" == *"Merge branch"* ]]; then
            echo "is_direct_push=false" >> $GITHUB_OUTPUT
          else
            echo "is_direct_push=true" >> $GITHUB_OUTPUT
          fi

      - name: Create warning issue
        if: steps.check.outputs.is_direct_push == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pusher = context.payload.pusher.name;
            const commitSha = context.sha.substring(0, 7);
            const commitUrl = `${context.payload.repository.html_url}/commit/${context.sha}`;
            const commitMsg = context.payload.head_commit.message.split('\n')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Direct push to main detected: ${commitSha}`,
              body: `## Branch Protection Notice

**@${pusher}** pushed directly to \`main\` instead of using a pull request.

**Commit:** [${commitSha}](${commitUrl})
**Message:** ${commitMsg}

---

### Repository Rules
- Only repository owners should push directly to \`main\`
- All collaborators should:
  1. Create a feature branch (\`feat/\`, \`fix/\`, etc.)
  2. Push changes to the feature branch
  3. Open a pull request for review
  4. Merge via the pull request

If you are a repository owner, you can close this issue. Otherwise, please follow the branching workflow for future changes.`,
              labels: ['branch-protection-warning']
            });
